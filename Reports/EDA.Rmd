---
title: "EDA"
author: "Allan"
date: '2023-06-14'
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
    theme: paper
editor_options:
  markdown:
    wrap: 72
always_allow_html: yes
---

```{r, echo = FALSE, message = FALSE, include=FALSE}
source(here::here("Scripts/SetUp.R"))
```

```{r, include=FALSE}
source(file = here::here("Scripts/Cleaning_and_Wrangling.R"))
```

The Data we have :

```{r}
general_df %>%
  select(c(1, 9:15)) %>%
  kable_head()
```

Quick overlook : 

Dayly Consumption in Million
```{r}
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index("2018-01-01" ~ "2022-11-01") %>% 
  autoplot() + 
  ggtitle("Total energy consumed in Switzerland") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```

-> Strong seasonlity, no obvious trend
-> seems to have diffent level of seasonility but hard to get due to the scope


Dayly Production
```{r}
general_df %>%
  group_by(date) %>% summarize(Total_prod = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index("2018-01-01" ~ "2022-11-01") %>% 
  autoplot() + 
  ggtitle("Total energy produced in Switzerland") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```

-> also Strong seasonlity, no obvious trend but more messy
-> seems to have diffent level of seasonility but hard to get due to the scope



Zoom in to see the monthly seasonality

 Monthly
```{r}
# Consumption
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index(. ~ "2022-11-01") %>% 
  autoplot() + 
  ggtitle("Total energy consumed in CH") + 
  ylab("Ammount in million of kWh") + xlab("Date") #Check outliers
```
Strong seasonality, no trend, peaks in Winter, lowest in sommer

```{r}
# Production
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index(. ~ "2022-11-01") %>% 
  autoplot() + 
  ggtitle("Total energy produced by CH") + 
  ylab("Ammount in million of kWh") + xlab("Date") #Check outliers 
```
opposite of consumption, Strong seasonality, no trend, peaks in Summer, lowest in winter

```{r}
# Consumption
general_dfM %>%
  group_by(month) %>%
  summarise(Total = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index("2016-01-01" ~ "2022-11-01") %>%
  gg_subseries(Total) +
  ylab("Total sales") + 
  xlab("Month") +
  ggtitle("Seasonal subseries plot: End users consumption")
```
Better view that confirmed what we previous said for consumption

```{r}
# Production
general_dfM %>%
  group_by(month) %>%
  summarise(Total = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index("2016-01-01" ~ "2022-11-01") %>%
  gg_subseries(Total) +
  ylab("Total sales") + 
  xlab("Month") +
  ggtitle("Seasonal subseries plot: Energy production")
```
  
Better view that confirmed what we previous said for prodcution

Zoom in to see the weekly seasonality

```{r}
# Consumption
general_df %>%
  group_by(hourly) %>% 
  summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>% 
  filter_index("2019-01-06" ~ "2019-01-30") %>% 
  autoplot() + 
  ggtitle("Total hourly energy consumed in CH") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```

We can see here both weelky and daily seasonlaty : 
With peaks during days (morning and end of afternoon) and during week with higher volume on weekday (no significant difference among days themselves)

```{r}
# Global effect of the weekday on consumption
general_df %>% 
  group_by(hour, wday) %>% 
  summarise(Total_cons = sum(energy_cons)/10000000) %>%
  ggplot(aes(wday, hour, fill = Total_cons)) +
  geom_tile() +
  labs(x = "Day of the week", y = "Hour of the day", fill = "Energy consumed [10m]") +
  scale_fill_distiller(palette = "Spectral") +
  theme_hc()
```

Trend is generalized through the whole period, peaks around noon


```{r}
# Production
general_df %>%
  group_by(hourly) %>% 
  summarize(Total_cons = sum(energy_prod)/1000000) %>%
  as_tsibble() %>% 
  filter_index("2019-01-06" ~ "2019-01-30") %>% 
  autoplot() + 
  ggtitle("Total houlry energy produced in CH") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```

same conclusion as consumption

```{r}
# Global effect of the weekday on production
general_df %>% 
  group_by(hour, wday) %>% 
  summarise(Total_cons = sum(energy_prod)/10000000) %>%
  ggplot(aes(wday, hour, fill = Total_cons)) +
  geom_tile() +
  labs(x = "Day of the week", y = "Hour of the day", fill = "Energy consumed [10m]") +
  scale_fill_distiller(palette = "Spectral") +
  theme_hc()
```

Trend is generalized through the whole period, peaks around 9am and 7pm, almost 0 prod btw 0 and 5 am -> noise and poeple aint working


We can now build the stl decomp with additive paramater due to no change over time in the seasonlity :

```{r}
# 2019 only with additive specification
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index("2019-01-01" ~ "2019-12-31") %>%
  model(classical_decomposition(Total_cons, type =
                                  "additive")) %>%
  components() %>%
  autoplot() + xlab("Year")
```

We reduce the scope to a year the have a better a view of the data, we have shown that seasonality was constant over the year. also show us the weekly seasonality

```{r}
#2019 only with additive specification
general_df %>%
  group_by(date) %>% summarize(Total_prod = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index("2019-01-01" ~ "2019-12-31") %>%
  model(classical_decomposition(Total_prod, type =
                                  "additive")) %>%
  components() %>%
  autoplot() + xlab("Year")
```

Same for production


```{r}
# Consumption
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index(. ~ "2022-11-01") %>%
  model(classical_decomposition(Total_cons, type =
                                  "additive")) %>%
  components() %>%
  autoplot() + xlab("Year")
```

Monthly seasonality for cons

```{r}
# Production
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index(. ~ "2022-11-01") %>%
  model(classical_decomposition(Total_cons, type =
                                  "additive")) %>%
  components() %>%
  autoplot() + xlab("Year")
```

Monthly seasonality for prod


Let's have a look at the residuals :
```{r}
# Monthly consumption
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_cons)) %>%
  as_tsibble() %>%
  filter_index(. ~ "2022-11-01") %>% 
  ACF(Total_cons) %>% 
  autoplot()
```
for cons

```{r}
# Monthly production
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_prod)) %>%
  as_tsibble() %>%
  filter_index(. ~ "2022-11-01") %>% 
  ACF(Total_cons) %>% 
  autoplot()
```

for prod

Positive and Negative Secondary control with trend

```{r}
# Positive secondary
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(pos_second)/1000) %>%
  as_tsibble() %>%
  filter_index("2019-01-01" ~ "2022-11-01") %>% 
  autoplot() +
  autolayer(components(STL_dcmp_PS), trend, color = 'red') +
  ggtitle("Positive secondary control energy") + 
  ylab("Ammount in million of kWh") + xlab("Date")

# Negative secondary
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(neg_second)/1000) %>%
  as_tsibble() %>%
  filter_index("2019-01-01" ~ "2022-11-01") %>% 
  autoplot() + 
  autolayer(components(STL_dcmp_NS), trend, color = 'red') +
  ggtitle("Negative secondary control energy") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```


Positive and Negative Tertiary control with trend

```{r}
# Tertiary data for consumption & production
# Positive tertiary
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(pos_tertiary)/1000) %>%
  as_tsibble() %>%
  filter_index("2019-01-01" ~ "2022-11-01") %>% 
  autoplot() + 
  autolayer(components(STL_dcmp_PT), trend, color = 'red') +
  ggtitle("Positive tertiary control energy") + 
  ylab("Ammount in million of kWh") + xlab("Date")

# Negative tertiary
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(neg_tertiary)/1000) %>%
  as_tsibble() %>%
  filter_index("2019-01-01" ~ "2022-11-01") %>% 
  autoplot() + 
  autolayer(components(STL_dcmp_NT), trend, color = 'red') +
  ggtitle("Negative tertiary control energy") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```


Let's do the same for Cantons :
-> Where is the electricity consumed and where does it come from ?
-> what drives it ? density, mapping, policy, mapp of barrage/hydrolyique central, plant and so on

What data do we have :

All the different cantons where set as variable (horizontal), in order to perform the anaylsis we needed to transform our Data-set in a vertical shape. 

Here is what the final version look like (we only show 1 variable for the Time)

```{r}
canton_df_long %>%
  select(c(1, 9:11)) %>%
  kable_head()
```


-> We have, for each 15-minute period, the consumption and production of each Cantons.
As said in introduction, some Cantons have been grouped together. You can see the breakdown here:

```{r}
unique(canton_df_long$Cantons)
```

24 Cantons (do not differentiate half-canton) spread over 18 values. 
-> For further analysis, we will split the value to get the 24 cantons. Method and results will be presented in an other section. 

```{r}
# Best consumer
canton_df_long %>% 
  filter(year > 2017) %>%
  group_by(Cantons) %>% 
  summarize(Total_cons = sum(consumption)/1000000) %>%
  ggplot(aes(x = Total_cons, y = Cantons, fill = Cantons)) + 
  geom_col(color = "black") + 
  guides(fill = FALSE) +
  ggtitle("Total consumption per canton since 2018, in millions") +
  xlab("Total energy consumed") + ylab("")

# Best producer
canton_df_long %>% 
  filter(year > 2017) %>%
  group_by(Cantons) %>% 
  summarize(Total_prod = sum(production)/1000000) %>%
  ggplot(aes(x = Total_prod, y = Cantons, fill = Cantons)) + 
  geom_col(color = "black") +
  guides(fill = FALSE) +
  ggtitle("Total production per canton since 2018, in millions") + 
  xlab("Total energy produced") + ylab("")
```
Many difference here :
Higher standard deviation for production
Consumption and Production seems independent -> not driven by the same variable

Let's see the monthly seasonality and trends over time for the top 3 of each category :

```{r}
# Monthly consumption top 3
canton_df_long %>% 
  filter(Cantons %in% top3_producer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(consumption)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  autoplot() + 
  ggtitle("Monthly consumption per canton since 2018") + 
  ylab("Ammount in million of kWh") + xlab("Date")

# Monthly production top 3
canton_df_long %>% 
  filter(Cantons %in% top3_producer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(production)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  autoplot() + 
  ggtitle("Monthly production per canton since 2018") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```

STL decomp for top 3 prod and top 3 cons

```{r}
# Monthly consumption
canton_df_long %>% 
  filter(Cantons %in% top3_consumer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total_cons = sum(consumption)/1000000) %>% 
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  model(STL(total_cons))%>%
  components() %>% autoplot()

# Monthly production
canton_df_long %>% 
  filter(Cantons %in% top3_producer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total_prod = sum(production)/1000000) %>% 
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  model(STL(total_prod))%>%
  components() %>% autoplot()
```



Facet wrap per Cantons with and without free scale :

```{r}
# Consumption
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(consumption)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  autoplot() + 
  facet_wrap(~Cantons) +
  ggtitle("Monthly consumption per canton since 2018") + 
  ylab("Ammount in million of kWh") + xlab("Date")

# Production
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(production)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  autoplot() + 
  facet_wrap(~Cantons) +
  ggtitle("Monthly production per canton since 2018") + 
  ylab("Ammount in million of kWh") + xlab("Date")

# Monthly consumption with free scale
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(consumption)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  autoplot() + 
  facet_wrap(~Cantons, scales = "free") +
  ggtitle("Monthly consumption per canton since 2018 free scale") + 
  ylab("Ammount in million of kWh") + xlab("Date")

# Monthly production with free scale
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(production)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ "2022-11-30") %>% 
  autoplot() + 
  facet_wrap(~Cantons, scales = "free") +
  ggtitle("Monthly production per canton since 2018 free scale") + 
  ylab("Ammount in million of kWh") + xlab("Date")
```


Features analysis to check the strength of the seasonality/trend

```{r}
## Features analysis
canton_features_C %>%
  ggplot(aes(x = trend_strength, y = seasonal_strength_year, col = Cantons)) +
  geom_point(size = 2)

canton_features_P %>%
  ggplot(aes(x = trend_strength, y = seasonal_strength_year, col = Cantons)) +
  geom_point(size = 2)
```


