---
title: "Introduction"
author: "Allan"
date: '2023-06-14'
output:
  bookdown::pdf_document2:
    toc: yes
    toc_depth: '3'
  bookdown::word_document2:
    toc: yes
    toc_depth: '3'
  bookdown:html_document2:
    toc: yes
    toc_depth: 3
    number_sections: yes
    theme: paper
editor_options:
  markdown:
    wrap: 72
always_allow_html: yes
link-citations: yes
linkcolor: blue
subparagraph: yes
citecolor: blue
urlcolor: blue
header-includes:
  - \counterwithin{figure}{section}
---


```{r, echo = FALSE, message = FALSE, include=FALSE}
source(here::here("Scripts/SetUp.R"))
source(file = here::here("Scripts/Cleaning_and_Wrangling.R"))
```

# Exectutive Summary

**Approach and Purpose**

Master thesis, internship oriented
Different subject
Actual and related to my country


**Analysis and Data Insights**

Sissgrid
comprendre ou est produite et consommée l'energie
Comment le réseau marche et ses complexité.
Production and consumption all over the country
Different level of aggregation
Seasonity

**Recommendation and Suggestions**

Forecast and risk

# Introduction

## Electricity

Electricity, its price, consumption and production are at the heart of current debates. Whether it's environmental issues linked to the climate crisis and over-consumption, the economic challenges posed by rising prices around the world, or political debates such as the blacklisting of Russia, a major producer of natural gas for Switzerland, following the war in Ukraine, electricity is a major source of concern in Europe today. Over and above these aspects relating to Europe in general, Switzerland could be facing a real electricity shortage problem, given its dependence on imports. This is the point made by *l'economiesuisse* in [this article](https://www.economiesuisse.ch/fr/articles/energieticker-f), which states that : 

*"Une pénurie d'énergie l'hiver prochain: tel est le scénario que nous devons éviter par tous les moyens. Une telle situation serait dévastatrice pour l'économie. Dans le dossier «Sur le front de l'énergie», economiesuisse commente l'actualité et évalue les nouveaux développements sous l'angle économique."* 
 
The situation in Switzerland is complex and unique. Situated at the center of Europe, it can easily take advantage of imports and exports with its neighbours. What is more, Switzerland is a country with a lot of nature, lakes and mountainous regions, so it can use its topology to its advantage. Despite these advantages, and despite the fact that Switzerland still produces more electricity than it consumes, it cannot do without the help of its neighbours for its electricity production, particularly given the seasonal nature of this resource and the difficulty of storing it. Indeed, while Switzerland manages to be self-sufficient during the summer period (May to October), which is characterised by high production and lower consumption, the picture is different in winter: with consumption up by around 25% compared with the summer, coupled with a drop in local production due to lower river flows in winter, Switzerland has plenty to worry about. In fact, RST rightly points this out in its [article](https://www.rts.ch/info/economie/13304056-penurie-delectricite-cet-hiver-les-enjeux-en-cinq-questions.html) on the shortage that could affect Switzerland during winter.

Beyond the purely economic aspect, the ecological component of electricity consumption and production is coming back more and more: fossil fuels to be banned, a desire to get out of nuclear power and the will to invest massively in green, renewable energies have invaded Switzerland. However, the will to do the right thing is not enough: we need to find the right compromise between the ecological transition and the needs of the population. Whether we like it or not, Swiss electricity needs will always take precedence over environmental issues.

It is the latter that we are going to focus on in this paper: **electricity in Switzerland, where is it consumed or produced, and how? What are the main factors governing the grid?** To answer this question, we will be using data provided by Swissgrid, the company that manages all electricity transmission in Switzerland. 

## Swiss Grid

As previously stated, our main task will be to analyze the data provided by Swissgrib in order to better understand what drives the network. Once done, we will try to interpret these results in order to build a prediction model for the same data at different time scales. Before we can use their data, it is important to understand who Swissgrid is and what role it plays. Here are some of the main components that make up the company:

**Generation**

Despite its essential role in the transmission of electricity, it is important to emphasise that Swissgrid does not produce any electricity. Its sole role is to transport electricity between power plants and consumption areas via its network. Its mission, in addition to supplying energy where it is needed, is to ensure the stability of the grid: the quantity injected into the grid must therefore be re-evaluated according to demand at all times.

**Grid operation**

For the grid to function properly, it is essential that production and consumption are always in balance: Swissgrid must therefore ensure at all times that the energy consumed and produced are equal so that it can be transported safely. This is where their forecasting model comes into play and will be used to prevent any congestion or overloads. This information is generally transmitted directly to the power stations, which will increase or decrease power according to the desired volume.

**Market development**

Swissgrid is not only involved in the development and modernisation of its transmission system: it also ensures the development of the market.In fact it is responsible for minimising the costs associated with procurement, by varying suppliers abroad, for example. It is also Swissgrid that will make it possible, by means of ever more innovative infrastructures, to offer Swiss power stations new possibilities for transmitting the electricity they produce more easily.

**Maintenance and repairs**

Among its many tasks, one of the most essential remains the maintenance and upkeep of its infrastructure: Swissgrid must ensure that its pylons, lines, substations and so on are in good working order so that electricity flows safely. Divided into seven sites, they will be responsible for any repairs required.

**Infrastructure**

Swissgrid is responsible for planning, replacing and expanding the entire transmission system infrastructure. This is a complex task, as the grid is already experiencing congestion, new power plants are being connected on a regular basis, and the dynamics of the electricity markets continue to grow. As a result, it is necessary to expand the transmission network, which can be done through the targeted modernization and dismantling of parts of the network, rather than through the construction of new lines.

**Networking**

As Switzerland is at the heart of Europe, it is an integral part of its interconnected network. This collaboration between countries enables Switzerland and Europe to avoid any congestion or network failures. Ideally located, Switzerland acts as a transit country, storing a large quantity of electricity that will pass through the interconnected network.

**Consumption**

Although consumers play a central role in network stability, they are not directly connected to the network. In the event of imbalance, Swissgrid will, for example, ask cold stores or incineration plants to modify their consumption in order to restore the desired voltage level. The only exception is the Swiss Federal Railways (SBB), which are directly connected to the transmission grid.

**Switching substations**

Coupling stations located in substations serve as connection points between grid lines. In some installations, energy is transformed and transmitted to different levels of the grid. In addition, Swissgrid's grid control centers carry out line disconnection and connection operations in the substations, using coupling maneuvers to direct the flow of electricity.

**Network levels**

To enable end consumers to use the energy generated by power plants, voltage is stepped down to 400 and 230 volts across seven network levels. These levels include extra-high voltage, high voltage, medium voltage and low voltage, as well as three transformer levels linking them together.

**Transmission grid**

The grid is made up of power lines operating at 380 kilovolts or 220 kilovolts. These two voltages have their specific uses: the former is mainly used for importing and exporting electricity, while the latter is mainly used by the large Swiss power plants to supply their energy. It is necessary to use kilovolt voltages on the transmission network to enable efficient transport of energy over long distances, while minimizing losses.

## The Network

Power is an invisible but omnipresent element in our lives. We use it instinctively and often without thinking, whether it is turning on the light in the morning, starting the coffee machine or listening to the radio.

In Switzerland, electricity is available 24 hours a day, 365 days a year. But that does not go without saying, especially in winter, when electricity producers face particular challenges. The need for energy increases with snowfall, icy conditions and extreme cold. Unfortunately, electricity production in Switzerland cannot fully cover these additional needs, making the country dependent on electricity imports in winter.

As electricity cannot be stored on the transmission network, it is crucial that current injection and extraction are always equal. But ensuring the efficient transformation of electricity and maintaining a constant balance between energy production and consumption are real challenges. That is where Swissgrid comes in. They ensure that the same amount of electricity is supplied at all times as is used at any given moment, as well as the constant frequency of 50 Hertz. Swissgrid works 24 hours a day, 7 days a week to achieve this. To keep the grid in balance at all times, careful planning with power plants and electricity traders is essential. 

However, the Swiss transmission network can experience fluctuations and unforeseen loads. In such cases, operators must intervene to restore the balance by injecting more energy where needed, in order to bring the grid frequency back to its target value of 50 Hertz. It should be noted that this frequency is also maintained throughout the European interconnected grid, in collaboration with the other transmission system operators. When unforeseen fluctuations occur, the operators of the grid control centers use control energy. This is a reserve of energy that power plants make available to Swissgrid, and which can be used when needed. Power plants can increase or reduce their output at short notice, thus compensating for power imbalances. 

On the European interconnected grid, balancing energy production and consumption is a process in 3 steps. First comes the primary control energy. It is activated in the event of frequency fluctuations. Turbines in power plants throughout Europe react by adjusting their output. After a few minutes, this phase is replaced by secondary control, which is managed by Swiss power plants in response to an automatic signal from Swissgrid. Finally, after a quarter of an hour, operators use tertiary control energy manually. They give instructions to certain power plants in Switzerland or abroad to inject more or less energy into the grid. For more details on energy control, see the section devoted to it later in this paper.

The network in figures :

- Voltage of 380 and 220 kilovolts

- 250'000 kilometres long (6x around the world, the entire electrical network)

- 6'700 kilometres long (length of transmission network lines only)

- 12'000 pylons

- 147 substations

- 41 cross-border lines

- 2.5 billion Swiss francs of planned investment

Now that we have a better understanding of how the grid works, here are some figures on the production and origin of electricity in Switzerland : 

In 2021, 80% of the final electricity consumed in Switzerland was coming from renewable sources, accordind to [the confederation](https://www.admin.ch/gov/fr/accueil/documentation/communiques.msg-id-90221.html) (production + importation)

Regarding the swiss production only : 

- central hydraulics contributes to 61,5% of the production, coming from 682 different centrals

- nuclear power plants (28,9%)

- new renewable energies (solar, wind, biomass and small hydro power, 7.7%)

- fossil fuels (1.9%)

- 29.7% in production against 70.3% in importation

The difference lies mainly in imports/exports, as Switzerland is not autonomous in its energy spending.

As far as the confederation's objectives are concerned, it wishes to : 

- reduce energy consumption per inhabitant by 43% by 2035 compared with 2000

- develop renewable energies as far as possible

- phase out nuclear power.

## Law, limits and regulations

**Electromagnetic field**

Whether we are talking about high-voltage lines or electrical equipment, potential risks of electromagnetic radiation is often raised. Electromagnetic radiation takes the form of electric and magnetic fields. To protect our health, limit values have been set. Swiss standards on electromagnetic radiation are among the most stringent in the world.

The immission limit value of 100 microteslas for magnetic fields is aimed specifically at preventing scientifically recognised harmful effects on health. It applies wherever people are likely to be. Under the Swiss Environmental Protection Act, it is also necessary to protect the population against health risks that are not yet proven but could be envisaged. This is precisely the role of the installation limit value of 1 microtesla. It applies to all places where people stay for a long time, such as living rooms, bedrooms, schools and playgrounds. Again, this limitation of 1 microtesla is one of the strictest in Europe. Both limit values are based on the maximum load of a power line.

**Noise**

Power lines can be subject to local electrical discharges, known as corona discharges, which occur particularly in adverse weather conditions such as rain, frost or wet snow. These coronal discharges can cause perceptible noises such as crackling or buzzing.

In Switzerland, there is a noise emission limit of 55 decibels in inhabited areas (reduced to 45 decibels at night), which must be strictly adhered to. It is important to note that the noise level in a busy street generally exceeds 80 decibels. As far as possible, Swissgrid implements all the necessary technical solutions to reduce the effects of corona discharges. In the case of underground power lines, the noise caused by the corona effect is eliminated.

**Environment**

In accordance with the approval procedure (UVP), the environmental impact assessment (UVB) ensures that a project complies with environmental protection legislation. The compliance check is based on an Environmental Impact Report. As the project owner, Swissgrid is responsible for drawing up and submitting the UVB documents. However, its preparation is generally entrusted to an independent and specialised engineering firm. The report examines various aspects such as noise, non-ionising radiation, water resources, soils, abandoned landfill sites, forests, natural habitats, wildlife, landscapes, built-up areas, historical monuments and archaeological sites.

The environmental monitoring of the construction phase (UBB) deals with and supervises environmental considerations during the construction phase and provides support to the project owner to ensure that the construction project complies with legislation and respects the environment.

**Approval process**

Swissgrid is responsible for planning and building electricity transmission infrastructure. The Confederation has established a six-stage procedure for the authorisation and approval of these projects. This procedure takes into account the requests and opinions of numerous entities, all of which are involved in the project. In order to validate the project, it is the authorities who will be responsible for giving the final verdict on the precise location and the tools to be put in place for the construction of the lines.

The 6 steps in question:

- Preparation : setting up an agreement between the cantons concerned to ensure that overhead and underground lines are correctly positioned

- Transmission Lines sectoral plan (SÜL) : the Confederation's main planning and coordination instrument, used to expand the transmission lines.

- Construction project : specific preparation of the construction project.

- Planning approval procedure : once all the planning has been completed, Swissgrid submits the application for construction  permission, which is then made public and analysed before a final response is given, which may be subject to conditions.

- Legal proceedings : At this stage, anyone affected by the project can lodge an objection, final decision will be given by the Federal Administrative Court and the Federal Supreme Court.

- Construction : once all the conditions have been met and the project has been fully validated, construction can begin.

All these procedures enormously slow down the expansion of the network, which generally takes 15 years from the creation of the project to its completion (opening of the line). Some objections have already caused projects to drag on for more than 30 years.

As a result of these slowdowns, Swissgrid is unable to keep pace with the development of green energies and frequently has to ask power stations to reduce their output. It is therefore imperative that Swissgrid is able to accelerate the expansion of its grid.

## Our goals

The main aim of this work is to understand what regulates the Swiss electricity market and how it behaves. Topics covered will include: electricity consumption and production, its distribution within the country and its trade with neighboring countries. We will also take a brief look at the risk to grid stability regulated by control energy.

In addition, Swissgrid needs to make its forecasts well in advance, so as to be well prepared for any eventuality. The first forecasts are made at one year, then at one month and one week before being recalculated one last time at 2 and 1 day before operation. You will also find a section where we will try to make predictions about consumption and production using several models, and then assess their accuracy.

# Preliminary Data Anylsis
## Overview of the data

First, we have data from Swissgrid regarding the energy network :

- Date : A file per year since 2009

- Time : Timestamp of 15min or 1hour (only overall for 1h)

- Total cons for end user only : are not included : grid losses, energy consumed for power plant’s own requirements or to drive the pumps in pumped storage hydro power plant.

- Total prod/cons for Switzerland : everything consumed/fed in the network

- Secundary control : positive and negative energy within 15min

- Tertiary control : positive and negative energy after the first 15min

- Vertical load Swiss transmission grid : will not be used

- Net outflow of the Swiss transmission grid : will not be used

- Grid feed-in Swiss transmission grid : will not be used

- Control energy prices : average price in CHF for the last 15min of control energy (rounded to 2 decimals) for second and tertiary control

- Cross border exchange : energy exchanged with bordered country (Austria, Germany, France, Italy)

- Import/export/transit : Transit is not included in the cross border exchange

- Cantons : Details of prod/cons per cantons (starts after 2015) grouped in 19 cantons

- Foreign territories : prod and cons for regions within the control zone of Switzerland but do not belong to its territory

We have a total of 65 variables with a total of 487872 observations.

Second, we got data from [gadm](https://gadm.org/) providing maps and spatial data for many countries on 4 different levels. In our project, we will use the data for Switzerland on a Canton level. 

## Data limitations

As said, we only have data available for each cantons since 2015. Also, due to the density of each cantons, certain areas have been grouped together, meaning we do not have the detail for every cantons. (26 cantons grouped into 19 zones) 

## Data cleaning and pre-processing
Due to the importance of the number of variables, we have decided to create sub-dataset for every type of Data :

- Overall

- Cantons

- Borders

- Foreign

- Price

Every DataSet had been transformed into a tsibble, a new data structure that help and support with temporal data. One should look at [this paper](https://arxiv.org/pdf/1901.10257.pdf) for further references. We used the timestamp of 15min to get a better understanding of the data and help us building stronger models and forecast. 

All the different cantons where set as variable (horizontal), in order to perform the anaylsis we needed to transform our Data-set in a vertical shape. 

Here is quick overlook of our dataset :

| Dataset          | No. observations |                                                     | Name of the DS  |
|--------------|--------------|-------------------------------|--------------|
| Initial dataset  | 277'536          | Combined all SwissGris's files from 2015            | General_df      |
| Monthly data     | 277'536          | Monthly version of General_DF                       | General_dfM     |
| Cantons'Data     | 4'995'648        | Combined Data for Cantons from 2015                 | Canton_df_long  |
| Swiss map's data | 123,156          | Contain data to map Switzerland                     | gadmCHE1        |


A new tidy data structure to
support exploration and modeling
of temporal data

# EDA

## Overall consumption and production for the country

### Quick visualisation

Now that we have better view of the network and where the data come from, let's dive int and see exactly what kind of data we will use.
You can see below the first 10 rows of the general_df data containing all the general information at the country level :

```{r}
general_df %>%
  select(c(1, 9:15)) %>%
  kable_head()
```

In the following exploration data analysis, we will only take the `energy_cons` and `energy_prod` as total of consumption and production. A important component when working with times series is the missing value. Indeed, many packages used in R can not deal NA. It is also the case for the `tsible` package which we will use throughout this paper. For further information on this new tidy data structure, one can refer to this [article](https://arxiv.org/pdf/1901.10257.pdf) on the subject.

After a quick check, we see that we have a total of missing value of : 

```{r, echo = TRUE}
sum(is.na(general_df))
```
We now know that no data is missing and that we have an observation for every 15 minutes from January 1, 2015 to the end of 2022. In the subsequent analysis, we will also transform our data into hourly (`hourly`), daily (`date`) and monthly (`month`) observations to obtain different insight. 

We can now have a first look on the Daily Consumption :

```{r}
general_df %>%
  group_by(date) %>% summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() +
  labs(title = "Total energy consumed in Switzerland",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "")
```

We can already see a strong yearly seasonality effect : for each year, we see peaks at the end/begging of the year (winter season) with big decrease during summer. We can also observe numerous variations over shorter periods, indicating possible seasonality on several levels. Giving the nature of the electricity, this results makes perfect sense : we can expect variation during day and night, weekday and weekend, winter and summer. We will have to work with different time period to understand each of these seasonal effects. Finally, the chart shows high volatility with several peaks each year. Considering them as outliers would not make sense since they occur very often, we will instead try to find out if we can explain a pattern of increase/decrease in consumption on the total from the data at hand.

Let's now have a look on the Daily Production to see if we get similar results :

```{r}
general_df %>%
  group_by(date) %>% summarize(Total_prod = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() +
  labs(title = "Total energy produced in Switzerland",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "")
```

Exactly as for consumption, we can see a strong seasonality over time, also operating on different time period. One difference to note is the possible downward trend after mid-2019. They yearly seasonality pattern seems also less consistent over the years. Clearly, if we can affirm correlation between consumption and production, we already see they behave differently. We will try to understand and explain where the difference come from. Finally, we see the same high volatility with several peaks each year we had for consumption.

### Different levels of seasonality

One of the conclusions we were able to draw based on the previous graphs was the presence of different seasonality in the data. To understand the patterns, we will "zoom in" to see what is happening on shorter time period. (starting with a long period and then gradually reducing it)

#### Seasonality of the month over the year

Our analysis starts with data grouped by month.
Here is the graph monthly consumption :

```{r}
# Consumption
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  autoplot() + 
  labs(title = "Total energy consumed by Switzerland",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") 
```

This clearly confirms what we have said previously :

- The levels of consumption does not vary over time.

- Significant difference between summer and winter, with a peak for consumption in December/January and the lowest in July/August. 
- The covid had almost no impact on consumption (2020 is slightly lower than other years, but we can not see any significant difference).

```{r}
# Production
general_dfM %>%
  group_by(month) %>% summarize(Total_cons = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  autoplot() + 
  labs(title = "Total energy produced by Switzerland",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") 
```

What we can extract from the chart :

- We can see  more clearly the difference with consumption : we do not have the same regularity with seasonality. We can confirm peaks and drops with the season but with less regularity. 

- If the general level of production is quite the same between the beginning and the end of the time perdiod, we see a higher variance among the year.

- For the covid period (year 2020 in Switzerland) : we see a redudction in the seasonilty, with significantly smaller peaks and falls throughout this year, with the old pattern appearing to return right after 2020.

- Finally, as mentioned in the previous section, there might be a general decrease in production after the highest point in 2019.

Here is an other view of the same data, grouped by month over the years :

```{r}
# Consumption
general_dfM %>%
  group_by(month) %>%
  summarise(Total = sum(energy_cons)/1000000) %>%
  as_tsibble() %>%
  filter_index("2016-01-01" ~ .) %>%
  gg_subseries(Total) +
  ylab("Total sales") + 
  xlab("Month") +
  labs(title = "Seasonal subseries plot: Energy consumption",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") 
```

This graph allows us to better compare the differences between the months for each year. The consistency of dips and peaks between summer and winter is clearer than ever. We can also note that the average consumption value (blue line on the graph) shows us a generally low level over a longer period than we might have thought: we can see a drop from April to September, contrary to our first analysis which suggested only the months of July and August. As for the differences between the years themselves, the variance is not very large, so we can say that overall consumption has changed little since 2016. Finally, we note a significant drop between March and June 2020, most likely linked to Covid, which we were unable to see clearly in the previous graphs.

```{r}
# Production
general_dfM %>%
  group_by(month) %>%
  summarise(Total = sum(energy_prod)/1000000) %>%
  as_tsibble() %>%
  filter_index("2016-01-01" ~ .) %>%
  gg_subseries(Total) +
  ylab("Total sales") + 
  xlab("Month") +
  labs(title = "Seasonal subseries plot: Energy production",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") 
```
  
The first thing we notice is the very high variance within months among each year. Indeed, we can see many big drops and peaks for several periods, especially for February 2017 and for the end of 2019 in general. Clearly, the year has a significant impact on production, indicating that it depends on more than just population density or labor.

This high variance can also lead to misinterpretation of the graph: one might think that the average value of production (blue lines) does not vary significantly from one month to the next, compared with consumption. This is mainly due to the higher scale of the y-axis, caused by high volatility. The range of production (4,500 to 6,500) is even higher than that of consumption (4,600 to 6,400), also showing the strong importance of seasons. 

#### Seasonality of the day over the week

Now that we have a better understanding of the monthly seasonality, let's zoom in on weekly seasonality. To do so, we will take the hourly data in a shorter time period.

You can see here the chart of the consumption per hour for the month of January 2019 (2019-01-06 ~ 2019-01-30, to be exact)

```{r}
# Consumption
general_df %>%
  group_by(hourly) %>% 
  summarize(Total_cons = sum(energy_cons)/1000000) %>%
  as_tsibble() %>% 
  filter_index("2019-01-06" ~ "2019-01-30") %>% 
  autoplot() + 
  labs(title = "Total hourly energy consumed in Switzerland",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "")
```

This graph shows us both weekly and daily seasonality : 

We have peaks during the day (in the morning and a second peak in the late afternoon) and dips during the night, but also during the week, with higher volumes on weekdays with less than half for the weekend. There is no significant difference between the days of the week themselves. This can easily be explained but the weekly and daily agenda of most people : the peaks happens when poeple are awake and are working. 

An interesting comparison is the small difference between weekend days and weeknights: the total amount consumed is almost the same, with some nights even exceeding weekend consumption. This suggests that the majority of consumption comes from companies and large institutes, and not from private individuals. Indeed, these two times of the week are marked by the absence of work.

It is important to note that we only have data for a specific month over a 6-year period : so while this gives us a general idea of consumption behavior throughout days and weeks, and we can expect it to be constant over the whole period, we can not yet be sure that this pattern is generalizable to every period.

As usual, let's now displays the same chart but this time for the production :

```{r}
# Production
general_df %>%
  group_by(hourly) %>% 
  summarize(Total_cons = sum(energy_prod)/1000000) %>%
  as_tsibble() %>% 
  filter_index("2019-01-06" ~ "2019-01-30") %>% 
  autoplot() +
  labs(title = "Total houlry energy produced in Switzerland",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "")
```

It gives us some very important indications. First of all, the production range is higher, which means that we produce too much during the day and not enough at night. This lack of electricity at night could be a choice, given that its price is very low and that importing electricity could be cheaper than producing it during a period of low activity.

In contrast to consumption, we have similar production on every night of the week (around 5 millions). Even lower than during the weekdays, the weekend is always higher than nights: the fact that production is low at weekends highlights human dependency. Indeed, if factories were 100% autonomous, we should not see a drop in production at weekends. However, it remains to be seen whether this drop is due to a reduction in manpower or simply a choice on the part of the factories, since demand is much lower at weekends.

Generally speaking, we can see that production for this period is in line with consumption.

#### Seasonality of the hour over the day

Our final zoom will focus on hourly/daily seasonality. As usual, we will display the consumption graph first, before the production graph. Instead of a conventional graph, given the short period between observations (every hour), we have decided to use a heat map this time. This has enabled us to use all the data at our disposal, while giving us a clear model output. This will thus enable us to confirm the models studied over the whole period. 

You can see below the first heat map, containing the data for consumption. 

```{r}
# Global effect of the weekday on consumption
general_df %>% 
  group_by(hour, wday) %>% 
  summarise(Total_cons = sum(energy_cons)/10000000) %>%
  ggplot(aes(wday, hour, fill = Total_cons)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_hc() +
  labs(title = "Global effect of the weekday on consumption",
       subtitle = "Energy consumed (in 10m of kwh)",
       y = "", x = "", fill = "")
```

We can conclude that the trend is generalized over the whole period, with peaks around midday and a gradual decrease as the day progresses. Minimum consumption can also be generalized between nights and weekends. Electricity consumption in Switzerland is clearly in line with human activity. 

Here is the second map, this time for production:

```{r}
# Global effect of the weekday on production
general_df %>% 
  group_by(hour, wday) %>% 
  summarise(Total_cons = sum(energy_prod)/10000000) %>%
  ggplot(aes(wday, hour, fill = Total_cons)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme_hc() +
  labs(title = "Global effect of the weekday on production",
       subtitle = "Energy consumed (in 10m of kwh)",
       y = "", x = "", fill = "")
```

The production pattern differs from the previous one: unlike an increase that would occur progressively, there are clear peaks and drops during the day, with a maximum around 7 p.m. (with a value 18% higher than maximum consumption). 

We can also confirm the absence of night-time production, with overall values more than 20% lower.

### STL Decomp

Now that we know exactly how our data works, we can go a step further and try to find the exact origin of these pattern. To do so, we will use the “Seasonal and Trend decomposition using Loess” (STL), one of the best smoothing methods. It allows us to divide the data into trend, seasonality and residuals, and analyze them separately.

Before doing it, we have to chose the right model for the decomposition (additive vs multiplicative). Since the overall level of data, seasonality included, does not change magnitudes from one year to the next, we have decided to chose the additive model.

We also have reduce the scope to five years (2018 to 2022) to get a better output. We have shown that seasonality is constant throughout the years, so we will not miss any important insight. 

Here is what the decomposition looks like for the consumption :

```{r}
# Consumption
components(STL_dcmpC) %>% autoplot() + 
  labs(title = "Additive STL decomposition for consumption",
       subtitle = "consumption = trend + season_year + season_week + remainder (in millions of kWh)",
       y = "", x = "")
```

Although the second is not very visible on the chart, STL has highlighted the annual and weekly seasonality as expected.

For the rest, the trend appears to be a cycle, with the shape of an oscillation. Looking at the monthly data, there were peaks in December and January. While this is true for the month as a whole, we see a sharp drop around Christmas and New Year, as well as in August. This is due to the fact that many people leave the country on vacation, causing daily consumption to drop significantly. 

Moving on to the decomposition of production, we get :

```{r}
# Production
components(STL_dcmpP) %>% autoplot() + 
  labs(title = "Additive STL decomposition for production",
       subtitle = "production = trend + season_year + season_week + remainder (in millions of kWh)",
       y = "", x = "")
```

Decomposition has proved very useful for production: whereas it was more difficult to extract patterns from previous graphs, the seasonality is obvious and regular once isolated. 

Production is highest in summer, when the weather is fine and the rivers have their maximum flow, and lowest in winter, with a sharp drop-off around the end-of-year holiday periods, when the power plants are less active and their staff are on vacation. Production may also have adjusted to a lower consumption forecast for the same period. 

Finally, as in the first decomposition, the weekly seasonality, although illegible on the graph, is clearly there.  

### Main insight from the overall Data

Similarities

- 3 levels of seasonality : daily, weekly and yearly.

- Low impact of the Covid on both variable.

- They are correlated to the weather, but for opposites reasons.

- When possible, production tries to match consumption 

Results from consumption

- Very regular data between years.

- Low in summer, high in Winter, with falls during high vacation periods.

- High volatility during winter, caused by winters of varying severity and low one during summer.

- Depends mainly on the weather: people use little electricity when it is warm and sunny, and much more when they need heating or light.

Results from production

- No clear pattern among years when we looked at the total energy produced.

- High in summer, low in Winter, with higher peaks and dips.

- Higher volatility among the year, since it depends more heavily on meteorological conditions, which vary from year to year. 

- Depends mainly on the weather: due to the nature of the production in Switzerland (hydroelectric and solar more specifically), it can produce more electricity during periods of high heat and rainfall, with higher river levels, than in winter, when it relies mainly on nuclear power plants.

## Secondary and Tertiary control

As explained in the introduction, control energy is used to guarantee the stability of the grid in Switzerland, and even in Europe. Indeed, since electricity can not be stored directly in the grid, we constantly need to add as much as we withdraw : consumption and production must always be at the equilibrium to have a stable grid. The value agreed for the entire European interconnected network is 50 Hertz and it is Swissgrid's job to make sure it always has the right power in its grid.

More specifically, control energy is used to remedy unexpected problems on the grid when actual electricity consumption is moving away from the forecasts, or when there is an unforeseen failure at a power station or at a consumer's premises for example. To overcome this problem, power stations will store energy for Swissgrid, which can be used when needed. They have the ability to adjust their output rapidly, thus compensating for fluctuations in electrical energy, whether excessive or insufficient.

Swissgrid purchases this control power capacity on specific markets created for this purpose. The amount of power required is put out to tender on online platforms, where power plants bid at a specified price. If a power plant wins the tender, it is obliged to supply the requested control power immediately and within a  a specified period. Swissgrid pays the power plant for this service. Power plants also receive additional compensation if secondary and tertiary control power is actually used.

As explain, this frequency control process takes place in three stages. Initially, Swissgrid will use primary control. This is used in the event of frequency fluctuations, immediately after the problem has been detected. The turbines in European power stations react by increasing or decreasing their output in order to restore balance. After a few minutes, primary control is replaced by secondary control, which is performed by Swiss power plants in response to an automatic signal from Swissgrid. If the problem persists, and generally after 15 minutes, grid operators manually use tertiary control energy, instructing certain power plants in Switzerland or abroad to inject more or less energy into the grid.

### Positive and Negative Secondary control with trend

As explained, we will consider control energy as representing the risk of the network. This is the reason why we will not go into the details of seasonality and so on, but rather analyse annual trends to see if there is an increase/decrease in its activity.

If the control area shows a positive balance, this indicates a deficit in the control area balance (i.e. insufficient coverage/increase in production  or a decrease in load). Conversely, if the control area balance is negative, this translates into a surplus in the control area energy balance (i.e. excess coverage).

Here is the situation for the secondary control from 2015 to December 2022 :

```{r}
# Positive secondary
general_df %>%
  group_by(year) %>% 
  summarize(Total_cons = sum(pos_second)/1000) %>%
  ggplot(aes(x = year, y = Total_cons)) + 
  geom_col(color = "black", fill = "#619CFF") + 
  guides(fill = FALSE) + 
  labs(title = "Positive secondary control energy per year",
       subtitle = "Ammount in thousands of kWh)",
       y = "", x = "")

# Negative secondary
general_df %>%
  group_by(year) %>% 
  summarize(Total_cons = sum(neg_second)/1000) %>%
  ggplot(aes(x = year, y = Total_cons)) + 
  geom_col(color = "black", fill = "#619CFF") + 
  guides(fill = FALSE) + 
  labs(title = "Negative secondary control energy per year",
       subtitle = "Ammount in thousands of kWh)",
       y = "", x = "")
```

With the exception of the first year, which was very high for both positive and negative control, there has been little change in the following years. 
The two values appear to be negatively correlated, with the positive secondary control value always slightly higher in absolute terms. 
As a reminder, the secondary control is used for balance problems lasting between 5 and 15 minutes. While the number of failures does not seem to increase over time, this latest graph doesn't allow us to draw any conclusions about the average duration of failures. 
To do this, we will compare it with tertiary control and see if it evolves differently.

### Positive and Negative Tertiary control with trend

We have seen that secondary control, with an average of around 150 millions of kWh per year, had neither increased nor decreased over the years. 

If secondary reserves are used for an extended period, this can completely empty primary reserves. The power system then becomes incapable of managing the resulting power imbalances on its own. This is where tertiary reserves come in.

Let's compare it to the tertiary sector: 

```{r}
# Tertiary data for consumption & production
# Positive tertiary
general_df %>%
  group_by(year) %>% 
  summarize(Total_cons = sum(pos_tertiary)/1000) %>%
  ggplot(aes(x = year, y = Total_cons)) + 
  geom_col(color = "black", fill = "#619CFF") + 
  guides(fill = FALSE) + 
  labs(title = "Positive tertiary control energy per year",
       subtitle = "Ammount in thousands of kWh)",
       y = "", x = "")

# Negative tertiary
general_df %>%
  group_by(year) %>% 
  summarize(Total_cons = sum(neg_tertiary)/1000) %>%
  ggplot(aes(x = year, y = Total_cons)) + 
  geom_col(color = "black", fill = "#619CFF") + 
  guides(fill = FALSE) + 
  labs(title = "Negative tertiary control energy per year",
       subtitle = "Ammount in thousands of kWh)",
       y = "", x = "")
```

The main difference lies in the last two years. Indeed, with a level similar to the secondary control (around 150 millions of kWh per year), values appear to be constant between 2015 and 2020. 

We can then see a sharp increase in tertiary activity, with values more than doubling for 2021 and almost quadrupling for 2022. 

This increase, combined with the previous graphs, indicates that the duration of incidents had increased enormously after 2020. The risk of failure is therefore no greater than before, but the time required to rebalance the network has increased. It is also worth noting that we do not have data on the exact duration of outages: we can say that they last more often than 15 minutes, but we do not have information on their exact duration. 

Although it would be very interesting to find out the exact causes of this sudden increase and develop more about control energies, we will not do it in this paper, which focuses more on general network trends and behavior. 

## Canton

### Quick visualisation

Now that we have seen how consumption and production behave for the country as a whole, we can move on to the cantonal level. The idea is to understand exactly where electricity production and consumption stand: are they similar for each canton, or do they depend on a number of factors? If so, are they the same for each category? Does Switzerland depend on just a few cantons for its electricity supply? 

These are just some of the questions we will try to answer in this section.

To do so, we will use the `Canton_df_long` dataset, which contains all the necessary information at the cantonal level.

Here is what the final version looks like :

```{r, out.width = "80%"}
canton_df_long %>%
  select(c(1:2, 4:5, 9:11)) %>%
  kable_head()
```

We can see that we have now for every time, the production and consumption for each canton.

A quick check of the total of missing value gives us : 

```{r, echo = TRUE}
sum(is.na(canton_df_long))
```

As said in introduction, some cantons have been grouped together. You can see the breakdown here:

```{r}
unique(canton_df_long$Cantons)
```

In all, we have 24 cantons (they do not differentiate between half-cantons) spread over 18 values. For further analysis, we will split the value to get the 24 cantons. Methods and results will be presented in an other section. 

Regarding the time period, as we have done previously, we will only represent data since 2018 to get a better view of on graphs.

Since we have so many cantons, showing them all on one chart would make it incomprehensible. So we will try to see whether certain cantons are major contributors to consumption or production, and then focus our analysis on them. 

You can find below the total consumption per area since 2015 :

```{r, out.width = "100%"}
# Best consumer
canton_df_long %>% 
  group_by(Cantons) %>% 
  summarize(Total_cons = sum(consumption)/1000000) %>%
  ggplot(aes(x = Total_cons, y = Cantons, fill = Cantons)) + 
  geom_col(color = "black") + 
  guides(fill = FALSE) + 
  labs(title = "Total consumption per canton since 2015",
       subtitle = "Ammount in millions of kWh)",
       y = "", x = "")

# Best producer
canton_df_long %>% 
  group_by(Cantons) %>% 
  summarize(Total_prod = sum(production)/1000000) %>%
  ggplot(aes(x = Total_prod, y = Cantons, fill = Cantons)) + 
  geom_col(color = "black") +
  guides(fill = FALSE) + 
  labs(title = "Total production per canton since 2015",
       subtitle = "Ammount in millions of kWh)",
       y = "", x = "")
```

Clearly, some cantons are responsible for most of our data. 

For the consumption, we have :

- Schaffouse and Zuirch, responsible of 73460 MkWH of the total consumption ()

- Berne and the Jura, accumulating a total of 63551 MkWH ()

- Geneve and Vaud, with a global consumption of 61111 MkWH ()

- Together, they are responsible of 41% of the total consumption

While for production, we see :

- Argovie, responsible of 103194 MkWH of the total prodcution ()

- The Valais, accumulating a total of 82975 MkWH ()

- Soleure, with a global production of 68353 MkWH ()

- Together, they are responsible of 54% of the totel consumption


In general, there is greater variance in production, with some cantons producing a great deal and others producing almost no electricity at all. 

Consumption and production appear to be independent: large consumers are not necessarily large producers, so it could be said that they are not driven by the same variable.

### Analyse of the top 3

For the next few charts, we will focus on the top 3 in each category.

Let's start by ploting the monthly time series for the top 3 consumers :

```{r, out.width = "100%"}
# Monthly consumption top 3
canton_df_long %>% 
  filter(Cantons %in% top3_consumer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(consumption)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() + 
  labs(title = "Monthly consumption per canton since 2018",
       subtitle = "Ammount in millions of kWh)",
       y = "", x = "")
```

The only noticeable difference among the cantons seems to be the level. Everything else looks the same : the general trend is flat and we have peaks and dips at the same period of the time. If we relate it to the total population of the canton,  we obtain (data available for 2021) :

- 1'121'271 for Berne and the Jura

- 1'332'416 for Geneve and Vaud

- 1'648'657 for Schaffouse and Zurich

The difference in levels can be explained by the total population of the regions.

```{r, out.width = "100%"}
# Monthly production top 3
canton_df_long %>% 
  filter(Cantons %in% top3_producer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(production)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() +
  labs(title = "Monthly production per canton since 2018",
       subtitle = "Ammount in millions of kWh)",
       y = "", x = "")
```

As we suggested earlier, production is not determined by total population. This is clearly confirmed by the graph above. Moreover, seasonality seems to be completely different for each canton, with staggered peaks and dips (exactly the opposite for Argovie and Valais). Finally, while Argovie and Valais show generally low production with peaks, Soleure seems to have generally high production with only dips, happening once a year. 

The production pattern really does differ from canton to canton, and we will look at it in more detail later in this section. 

To confirm these similarities/differences, we ran the STL decomposition for the 3 main electricity producers and consumers. Once again, we opted for an additive model.

Top 3 consumers STL decomposition :

```{r, out.width = "100%"}
# Monthly consumption
canton_df_long %>% 
  filter(Cantons %in% top3_consumer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total_cons = sum(consumption)/1000000) %>% 
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  model(STL(total_cons))%>%
  components() %>% autoplot() + 
  guides(
    colour = guide_legend(title = "Cantons")
  ) +
  scale_color_manual(labels = c("berne_jura", "geneve_vaud", "schaff_zurich"), 
                     values = c("#F8766D", "#00BA38", "#619CFF")) +
  labs(title = "STL decomposition",
       subtitle = "consumption = trend + season_year + remaFinder (in millions of kWh)",
       y = "", x = "")
```

The STL decomposition looks exactly as we expected :
the trends are almost parallel between the cantons, with similar oscillation shapes for the seasonality and almost superposed remainders. Once again, the main difference lies in the level of the trend, but not its direction.

For the second STL, you can see below the corresponding output :

```{r, out.width = "100%"}
# Monthly production
canton_df_long %>% 
  filter(Cantons %in% top3_producer) %>%
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total_prod = sum(production)/1000000) %>% 
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  model(STL(total_prod)) %>%
  components() %>% autoplot() + 
  guides(
    colour = guide_legend(title = "Cantons")
  ) +
  scale_color_manual(labels = c("argovie", "soleure", "valais"), 
                     values = c("#F8766D", "#00BA38", "#619CFF")) +
  labs(title = "STL decomposition",
       subtitle = "production = trend + season_year + remainder (in millions of kWh)",
       y = "", x = "")

```

The STL decomposition reinforces dissimilarity between cantons :

- While Soleure and Argovie have a flat trend, Valais seems to become positive at the end.

- If Valais production seems to peak in summer, the other two cantons have their lows at the same time.

- With the exception of a higher volatility in Argovie's remainder, we can not draw any conclusions.

### Facet wrap by Canton

Let's now look at each canton separately. We want to see whether we can find similarities in the data for both production and consumption, and whether we can group them by macroeconomic variable.

In other words: do we have specific patterns for each canton, some of them, or common to all? 

To do this, we analyzed each canton side by side in two different graphs: with and without a free scale.

The first will allow us to compare seasonality and the specific pattern, while the second will show us the total difference, in terms of overall consumption/production.  

Facet wrap per Cantons with and without free scale.

```{r, out.width = "100%"}
# Monthly consumption with free scale
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(consumption)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  mutate(xlabel = "") %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() + 
  facet_wrap(~Cantons, scales = "free") +
  guides(colour="none") +
  theme(axis.text.x = element_blank()) +
  labs(title = "Monthly consumption per canton since 2018",
       subtitle = "Ammount in millions of kWh with free scale",
       y = "", x = "")
```

```{r, out.width = "100%"}
# Consumption
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(consumption)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() + 
  facet_wrap(~Cantons) +
  guides(colour="none") +
  labs(title = "Monthly consumption per canton since 2018",
       y = "Ammount in millions of kWh", x = "") +
  theme(axis.text.x = element_text(angle=80, hjust=1))

#soleure [ici](https://enaw.ch/fr/protection-du-climat-et-performance-energetique-dans-le-canton-de-soleure/)

#glaris [ici](https://www.rts.ch/info/regions/autres-cantons/12430459-la-plus-grande-centrale-solaire-alpine-est-en-construction-a-glaris.html)

#glaris [ici](https://www.swissinfo.ch/fre/economie/linthal-2015_la-centrale-%C3%A9lectrique-la-plus-spectaculaire-et-la-plus-risqu%C3%A9e-de-suisse/42428090)

#valais [ici](https://www.watson.ch/fr/suisse/%C3%A9lectricit%C3%A9/213331089-voici-les-communes-suisses-qui-consomment-le-plus-d-electricite)

#valais [ski](chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://vanat.ch/RM-CH-palmares-JS2022-R-F-Laurent%20Vanat.pdf)
```

The first graph show the regular seasonality between cantons. Switzerland aims to reduce its electricity consumption, in line with its environmental policy. We can see that several cantons have already adopted this trend, and seem to have lower consumption at the end of the period than at the beginning.  

However, 3 cantons seem to behave in a very specific way, and need to be examined in greater detail: Glaris, Soleure and the Valais.

Upon further investigation, our research revealed that :

- Glaris : Clearly, with consumption doubling since 2018, it cannot be explained by demographic expansion alone. Operational since 2021, Glarus has begun construction of the largest power plant in the Alps.  
Located at an altitude of 2,500 metres on the Muttsee dam, it will be able to generate up to 2.2 megawatts of power.
The construction and use of the power plant, in addition to generating significant consumption, also enables the canton to be more independent and to expand some of its activities. The production graphs should also show a significant increase in output.

- Soleure : The sharp and rapid fall in consumption in the canton seems unnatural and impossible to explain. It may be a direct error in the data, and therefore not representative of reality. 
However, one possible explanation may lie in the company's desire to improve its energy efficiency in the interests of climate protection. Many companies have already achieved this, and according to *L'agence de l'énergie* : *"Leurs résultats sont remarquables."*

- The Valais : The Valais owns some of Switzerland's largest and most popular ski resorts. Swiss ski resorts have also seen an increase in visitor numbers following the Covid, which has restricted Switzerland much less than the rest of Europe.  
Rather than an upward trend, we can see higher consumption peaks in the post-2020 winters. Increased ski tourism and a renewed enthusiasm for the "Magic Pass", a pass that gives free access to numerous resorts throughout Switzerland, have boosted activity in the Valais during the winter season. With 34% of total volume, the Valais was the canton with the highest ski activity in 2021.


```{r, out.width = "100%"}
# Monthly prodcution with free scale
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(production)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() + 
  facet_wrap(~Cantons, scales = "free") +
  guides(colour="none") +
  labs(title = "Monthly production per canton since 2018",
       subtitle = "Ammount in millions of kWh with free scale",
       y = "", x = "") +
  theme(axis.text.x = element_blank())
```

```{r, out.width = "100%"}
# Production
canton_df_long %>% 
  mutate(month = yearmonth(date), year = year(date)) %>%
  group_by(month, Cantons) %>%
  summarize(total = sum(production)/1000000) %>%
  as_tsibble(index = month, key = Cantons) %>%
  filter_index("2018-01-01" ~ .) %>% 
  autoplot() + 
  facet_wrap(~Cantons) +
  guides(colour="none") +
  labs(title = "Monthly production per canton since 2018",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") +
  theme(axis.text.x = element_text(angle=80, hjust=1))

#Format de production pour Soleure et argovie provient des centrales nucléaire [ici](https://www.kernenergie.ch/fr/les-centrales-nucleaires-suisses-_content---1--1068.html)

#valais, grisons, berne/jura -> hydrolique 

#[ici](https://fr.wikipedia.org/wiki/Hydro%C3%A9lectricit%C3%A9_en_Suisse)
#[ici](https://www.bfe.admin.ch/bfe/fr/home/approvisionnement/energies-renouvelables/force-hydraulique.html#:~:text=Environ%2063%20%25%20de%20la%20production,quantit%C3%A9s%20consid%C3%A9rables%20d'%C3%A9nergie%20hydro%C3%A9lectrique.)

```

- much higher variance among cantons, with few (5 cantons) producing almost all the electricity.

- 2 types of seasonality : argovie and soleure with high values and yearls dips, Berne, grisons and Valais with classic seasonality, prdocing more during summer than winter.

- First group : use nuclera power plants
how it works ->

- Second group : alpine cantons, use mainly hydrolique power.
-> how it works

## Border

Now that we have seen everything that is going on internally in Switzerland, let's take a quick look at its borders trade.

Given its central geographical position in Europe, Switzerland plays an important role in the European electricity network. As already stated, Switzerland is not self-sufficient and depends on its neighbours for its electricity consumption, especially during the winter season, where it can not produce enough electricity on its own. However, having insufficient production does not mean, that Switzerland does not export electricity: we have shown that it also often finds itself in excess and must therefore find a way of freeing itself from this surplus. One simple and effective way of doing this is to redistribute it to neighbouring countries.

Having already analysed the seasonality of electricity consumption and production at length, we will now focus solely on global levels to see where electricity is exchanged. 

To do this, we have followed the same transformation procedure as we did for the cantons, which aimed to transform our variables into observations (horizontal to vertical shape), and then dividing our data into two groups: 

- the `imp_exp_long` df containing  all data aggregated for Switzerland concerning imports, exports and transit.

- the `border_long` df, with imports and exports broken down by the corresponding country (Italy, Austria, Germany and France).

We will start our analysis with the aggregated data before delving into each country separately.


```{r, out.width = "100%"}
imp_exp_long %>%
  group_by(year, Type) %>%
  summarize(total = sum(Amount)/1000000) %>%
  as_tsibble(index = year, key = Type) %>%
  ggplot(aes(x = as.factor(year), y = total, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(vars(Type), ncol = 3) +
  labs(title = "Total of yearly exchange with border countries since 2015",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") +
  theme(axis.text.x = element_text(angle=80, hjust=1),
        legend.position = "none")
```

Transit represents electricity that passes through Switzerland but is never consumed there. It could, for example, represent an exchange between Germany and Italy which, for geographical reasons, is obliged to pass through Switzerland. This graph shows that transit energy accounts for a significant proportion of the network, i.e. around 30% of the data shown above. This graph shows that transit energy accounts for a significant proportion of the network, i.e. around 30% of the data shown above. Contrary to what one might think, this quantity is not negligible and represents a real activity for Swissgrid. The data for Swiss imports and exports are similar, with overall levels close together and a slightly downward trend. As Switzerland's objective is to reduce its emissions in the med-term horizon, the data clearly shows that it is heading in the right direction. 

To sum up, Switzerland depends on both imports and exports of electricity to meet its energy needs. Imports are used to compensate for production shortfalls, while exports are made when production exceeds domestic demand.

We will now look at the distribution of these exchanges with the various Swiss countries. Please note that transit will not be taken into account.

Here are the data available since 2015:  

```{r, out.width = "100%"}
border_long %>%
  group_by(year, Type) %>%
  summarize(total = sum(Amount)/1000000) %>%
  as_tsibble(index = year, key = Type) %>%
  ggplot(aes(x = as.factor(year), y = total, fill = Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Type, ncol = 3) +
  guides(colour= "none") +
  labs(title = "Yearly exchange with border per countries since 2015",
       subtitle = "Ammount in millions of kWh",
       y = "", x = "") +
  theme(axis.text.x = element_text(angle=80, hjust=1),
        legend.position = "none")
```
We can see straight away that trade differs greatly from one country to another:

- Most of our electricity comes from Germany and very little, if any, from Italy.

- Electricity is mainly exported to Italy, with very low volumes to the other three countries, especially for Austria. 

- For Italy and Germany in particular, trade is strongly negatively correlated. 

- The general trend appears to be neither downward nor upward.

## Maps

To complete our chapter on visualization, we imported Swiss topographic data from the gamdech website. By integrating consumption and production data supplied by Swissgrid, we'll be able to show geographically how electricity is used. 
As previously stated, the Swissgrid data is not broken down into cantons and regions (18 zones instead of 26 cantons).  In order to merge the data, we'll need to separate the data for each region into its corresponding canton. 

Thanks to the analysis carried out in points 4.1 (overall) and 4.3 (canton), we have decided to split the data as follows:

- for consumption, it will be divided proportionally between the cantons of the same region according to their resident population (2021 data.

- production data will be distributed according to the surface area of the canton. 

These data come respectively from "l'Office fédéral de la statsiqtique" and "L'aménagement linguistique dans le monde."

The idea of these maps is to visually show the geographical distribution of consumption and production to see if we can correlate it with population density and the topography of the cantons. 

Here are the first maps, showing the distribution of population and electricity consumption: 

```{r, out.width = "80%"}
ggplot(Swiss_data) +
  geom_sf(aes(fill = Consumption)) +
  geom_sf_text(aes(label = Canton), size = 3.3, color = "black") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        axis.title = element_blank())

ggplot(Swiss_data) +
  geom_sf(aes(fill = Population)) +
  geom_sf_text(aes(label = Canton), size = 3.3, color = "black") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        axis.title = element_blank())
```

The two maps could hardly be more similar: the correlation seems almost perfect.  With the exception of Berne, where the difference remains very small, we can see that population is an excellent indicator of a canton's total electricity consumption. 

While population seems to be the right indicator for consumption, we have shown that it is unreliable for production. Indeed, given the way electricity is produced in Switzerland, we prefer to compare it with the country's topography. Switzerland is divided into 3 regions: the Alps, the Plateau and the Jura. We should therefore see higher production in the mountainous areas, with a level close to 0 in the flat regions of the country. 

You can find below the map of swiss's production :

```{r, out.width = "80%"}
ggplot(Swiss_data) +
  geom_sf(aes(fill = Production)) +
  geom_sf_text(aes(label = Canton), size = 3.3, color = "black") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"),
        axis.title = element_blank())
```

We said that we should expect high production from the jurassic part and the Apls, with lower value for the Swiss plateau.

Let's anaylse them separalty : 

- The Alps look exactly as we expected, with Valais, Grisons and Tessin (although slightly below the other two) having higher value compared to the rest of the country.

- With the exception of Berne, the plateau produces very little electricity. This difference is due to the way in which the data has been separated: geographically distributed, too much production has been attributed to Berne compared with the Jura, where the production centers are actually located. The same conclusion can be drawn for Vaud, where part of the data has been attributed to Geneva, which produces almost no electricity. 

- Finally, we can see that 2 regions produce a great ammount of electricity in an area with few mountains: Soleure and Argovie. This time, it is not due to a distribution error, but to the fact that these two cantons have a high level of nuclear activity, which is independent of their topography. 

# Forecasting 

# Conclusion and possible extension

# References and Appendix

- https://arxiv.org/pdf/1901.10257.pdf
- https://www.swissgrid.ch/fr/home.html
- https://gadm.org/
- https://www.admin.ch/gov/fr/accueil/documentation/communiques.msg-id-90221.html
- https://www.eda.admin.ch/aboutswitzerland/fr/home/wirtschaft/energie/energie---fakten-und-zahlen.html
- https://www.rts.ch/info/economie/13304056-penurie-delectricite-cet-hiver-les-enjeux-en-cinq-questions.html
- https://www.economiesuisse.ch/fr/articles/energieticker-f
- https://www.kernenergie.ch/fr/les-centrales-nucleaires-suisses-_content---1--1068.html
- https://fr.wikipedia.org/wiki/Hydro%C3%A9lectricit%C3%A9_en_Suisse
- https://www.bfe.admin.ch/bfe/fr/home/approvisionnement/energies-renouvelables/force-hydraulique.html#:~:text=Environ%2063%20%25%20de%20la%20production,quantit%C3%A9s%20consid%C3%A9rables%20d'%C3%A9nergie%20hydro%C3%A9lectrique.




